{% extends "base.html" %}

{% block title %}Run — WACEK - Strażnik TERGsasu{% endblock %}

{% block extra_head %}
<style>
    .action-btn {
        background: none;
        border: 1px solid var(--border);
        color: var(--text-secondary);
        padding: 0.25rem 0.6rem;
        font-family: 'Fira Code', monospace;
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: border-color 0.15s, color 0.15s;
    }
    .action-btn:hover {
        border-color: var(--text-primary);
        color: var(--text-primary);
    }
    .action-btn.danger:hover {
        border-color: var(--accent-red);
        color: var(--accent-red);
    }

    .run-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        align-items: start;
    }

    @media (max-width: 900px) {
        .run-grid { grid-template-columns: 1fr; }
    }

    .run-card {
        background: var(--bg-panel);
        border: 1px solid var(--border);
        padding: 1.5rem;
    }

    .run-card h3 {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 2px;
        color: var(--accent-green);
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--border);
    }

    .form-group {
        margin-bottom: 1.25rem;
    }

    .form-group label {
        display: block;
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-secondary);
        margin-bottom: 0.4rem;
    }

    .form-group select,
    .form-group input[type="number"] {
        width: 100%;
        box-sizing: border-box;
        background: var(--bg-dark);
        border: 1px solid var(--border);
        color: var(--text-primary);
        padding: 0.6rem 0.75rem;
        font-family: 'Fira Code', monospace;
        font-size: 12px;
    }

    .form-group select:focus,
    .form-group input:focus {
        outline: none;
        border-color: var(--accent-green);
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .checkbox-group input[type="checkbox"] {
        width: auto;
    }

    .checkbox-group label {
        margin: 0;
        font-size: 11px;
        text-transform: none;
        color: var(--text-primary);
    }

    .btn-run {
        background: var(--accent-green);
        color: var(--bg-dark);
        border: none;
        padding: 0.65rem 1.5rem;
        font-family: 'Fira Code', monospace;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        cursor: pointer;
        margin-top: 0.5rem;
    }

    .btn-run:hover { opacity: 0.85; }

    .info-box {
        background: var(--bg-dark);
        border-left: 2px solid var(--accent-yellow);
        padding: 0.75rem 1rem;
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 1rem;
    }

    /* Scenariusze — lista checkboxów */
    .scenario-list {
        max-height: 280px;
        overflow-y: auto;
        border: 1px solid var(--border);
        background: var(--bg-dark);
    }

    .scenario-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 0.75rem;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
        font-size: 12px;
        transition: background 0.1s;
    }

    .scenario-item-id {
        font-size: 12px;
        font-weight: 900;
    }

    .scenario-item:last-child { border-bottom: none; }

    .scenario-item:hover {
        background: rgba(0, 255, 136, 0.05);
    }

    .scenario-item input[type="checkbox"] {
        flex-shrink: 0;
        accent-color: var(--accent-green);
    }

    .scenario-item.selected {
        background: rgba(0, 255, 136, 0.08);
    }

    .select-all-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        border-bottom: 1px solid var(--border);
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-secondary);
        background: var(--bg-panel);
        cursor: pointer;
    }

    .selected-count {
        font-size: 10px;
        color: var(--accent-green);
        margin-left: auto;
    }
</style>
{% endblock %}

{% block content %}
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; height: 32px;">
    <h2 style="font-size:14px; letter-spacing:2px; text-transform:uppercase;">Uruchom Run</h2>
</div>

<div class="run-grid">

    {# ── Suite Run ─────────────────────────────────────────────────────────── #}
    <div class="run-card">
        <h3>▶ Suite Run</h3>
        <form method="POST" action="/execute">
            <div class="form-group">
                <label for="suite_id">Suite</label>
                <select name="suite_id" id="suite_id" required>
                    <option value="">Wybierz suite...</option>
                    {% for suite in suites %}
                    <option value="{{ suite.id }}">{{ suite.name }} ({{ suite.workers }} workers)</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="environment_id">Environment</label>
                <select name="environment_id" id="environment_id" required>
                    {% for env in environments %}
                    <option value="{{ env.id }}" {% if env.id == 1 %}selected{% endif %}>
                        {{ env.name }} — {{ env.base_url }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="workers_override">Workers</label>
                <input type="number" name="workers_override" id="workers_override"
                       min="1" max="10" placeholder="Domyślne z suite">
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" name="headless" id="headless" value="true" checked>
                    <label for="headless">Headless (bez okna przeglądarki)</label>
                </div>
            </div>

            <button type="submit" class="btn-run">▶ Run Suite</button>

            <div class="info-box">
                Suite zostanie uruchomiona w tle. Wyniki pojawią się w zakładce Runs.
            </div>
        </form>
    </div>

    {# ── Manual Run ────────────────────────────────────────────────────────── #}
    <div class="run-card">
        <h3>▶ Manual Run</h3>
        <form method="POST" action="/execute/manual" id="manual-form">

            <div class="form-group">
                <label for="manual_environment_id">Environment</label>
                <select name="environment_id" id="manual_environment_id" required>
                    {% for env in environments %}
                    <option value="{{ env.id }}" {% if env.id == 1 %}selected{% endif %}>
                        {{ env.name }} — {{ env.base_url }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>
                    Scenariusze
                    <span id="selected-count" class="selected-count"></span>
                </label>

                <div class="scenario-list">
                    <div class="select-all-row" onclick="toggleAll()">
                        <input type="checkbox" id="select-all" onclick="event.stopPropagation(); toggleAll()">
                        <span>Zaznacz wszystkie</span>
                    </div>
                    {% for scenario in scenarios %}
                    <label class="scenario-item" id="item-{{ scenario.id }}">
                        <input type="checkbox"
                               name="scenario_ids"
                               value="{{ scenario.id }}"
                               onchange="updateCount()">
                        <span class="scenario-item-id">#{{ scenario.id }}: </span>{{ scenario.name }}
                    </label>
                    {% endfor %}
                </div>
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" name="headless" id="manual_headless" value="true" checked>
                    <label for="manual_headless">Headless (bez okna przeglądarki)</label>
                </div>
            </div>

            <button type="submit" class="btn-run" id="manual-submit-btn" disabled>
                ▶ Run Manual
            </button>

            <div class="info-box">
                Wybrane scenariusze zostaną uruchomione jako "Manual Runs".
                Wyniki i alerty trafią do normalnego widoku.
            </div>
        </form>
    </div>

</div>

<script>
function updateCount() {
    const checked = document.querySelectorAll('input[name="scenario_ids"]:checked');
    const countEl = document.getElementById('selected-count');
    const submitBtn = document.getElementById('manual-submit-btn');
    const selectAll = document.getElementById('select-all');
    const total = document.querySelectorAll('input[name="scenario_ids"]').length;

    countEl.textContent = checked.length > 0 ? `${checked.length} / ${total}` : '';
    submitBtn.disabled = checked.length === 0;

    // Aktualizuj stan "zaznacz wszystkie"
    selectAll.checked = checked.length === total;
    selectAll.indeterminate = checked.length > 0 && checked.length < total;

    // Podświetl zaznaczone
    document.querySelectorAll('input[name="scenario_ids"]').forEach(cb => {
        const item = document.getElementById('item-' + cb.value);
        if (item) item.classList.toggle('selected', cb.checked);
    });
}

function toggleAll() {
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('input[name="scenario_ids"]');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
    updateCount();
}

// Init
updateCount();
</script>
{% endblock %}
