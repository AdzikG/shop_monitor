<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Shop Monitor{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/htmx.org@2.0.3"></script>
    <style>
        :root {
            --bg-dark: #000;
            --bg-panel: #0f0f0f;
            --bg-hover: #222;
            --text-primary: #fff;
            --text-secondary: #d1d1d1;
            --border: #333;
            --accent-green: #00ff41;
            --accent-red: #ff0055;
            --accent-yellow: #fff200;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Fira Code', 'Courier New', monospace;
            background: var(--bg-dark);
            color: var(--text-primary);
            font-size: 12px;
            line-height: 1.6;
        }
        
        header {
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        header h1 {
            font-size: 17px;
            font-weight: 700;
            letter-spacing: 2px;
            color: var(--accent-yellow);
        }
        
        nav {
            display: flex;
            gap: 1.5rem;
        }
        
        nav a {
            color: var(--text-secondary);
            text-decoration: none;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 1px;
            transition: color 0.2s;
        }
        
        nav a:hover,
        nav a.active {
            color: var(--text-primary);
        }
        
        main {
            padding: 32px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            padding: 1.5rem;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            font-family: 'Fira Code', monospace;
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--bg-panel);
            border: 1px solid var(--border);
        }
        
        th {
            background: var(--bg-dark);
            color: var(--text-secondary);
            text-align: left;
            padding: 0.75rem 1rem;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            border-bottom: 1px solid var(--border);
        }
        
        td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tr:hover td {
            background: var(--bg-hover);
        }
        
        .status {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .status.success {
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }
        
        .status.failed {
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
        }

        .status.inactive {
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
        }
        
        .status.running {
            color: var(--accent-yellow);
            border: 1px solid var(--accent-yellow);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        a.link {
            color: var(--text-primary);
            text-decoration: none;
            border-bottom: 1px solid var(--border);
            transition: border-color 0.2s;
        }
        
        a.link:hover {
            border-color: var(--accent-green);
        }
        
        .mono {
            font-family: 'Fira Code', monospace;
            color: var(--text-secondary);
        }
        
        .alert-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            background: var(--accent-red);
            color: var(--bg-dark);
            font-size: 10px;
            font-weight: 700;
            border-radius: 2px;
        }
    </style>
    {% block extra_head %}{% endblock %}
</head>
<body>
    <header>
        <h1>
            <img src="/static/icons/logo.png" 
         style="height: 20px; width: 20px; object-fit: contain; vertical-align: middle; margin-right: 0.5rem;">
            WACEK - StraÅ¼nik TERGsasu
        </h1>
        <nav>
            <a href="/dashboard" {% if request.url.path == '/dashboard' %}class="active"{% endif %}>Dashboard</a>
            <a href="/execute" {% if request.url.path == '/execute' %}class="active"{% endif %}>Uruchom</a>
            <a href="/suite-runs" {% if "/suite-runs" in request.url.path %}class="active"{% endif %}>Runy</a>
            <a href="/alerts" {% if "/alerts" in request.url.path %}class="active"{% endif %}>Alerty</a>
            <a href="/config" {% if "/config" in request.url.path %}class="active"{% endif %}>Konfiguracja</a>
        </nav>
    </header>
    
    <main>
        {% block content %}{% endblock %}
    </main>
<div id="pin-modal" style="
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
    z-index: 9999;
    align-items: center;
    justify-content: center;
">
    <div style="
        background: var(--bg-panel);
        border: 1px solid var(--border);
        padding: 2rem;
        width: 320px;
        max-width: 90vw;
    ">
        <h3 style="font-size: 12px; text-transform: uppercase; letter-spacing: 2px;
                   color: var(--accent-green); margin-bottom: 1.5rem;">
            ðŸ”’ Autoryzacja
        </h3>
        <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 1rem;">
            Podaj PIN aby wykonaÄ‡ akcjÄ™.
        </p>
        <input
            type="password"
            id="pin-input"
            placeholder="PIN"
            style="
                width: 100%;
                box-sizing: border-box;
                background: var(--bg-dark);
                border: 1px solid var(--border);
                color: var(--text-primary);
                padding: 0.5rem 0.75rem;
                font-family: 'Fira Code', monospace;
                font-size: 14px;
                margin-bottom: 0.5rem;
            "
        >
        <div id="pin-error" style="
            font-size: 11px;
            color: var(--accent-red);
            min-height: 1.2rem;
            margin-bottom: 1rem;
        "></div>
        <div style="display: flex; gap: 0.75rem;">
            <button onclick="submitPin()" style="
                background: var(--accent-green);
                border: none;
                color: var(--bg-dark);
                padding: 0.5rem 1.2rem;
                cursor: pointer;
                font-size: 11px;
                text-transform: uppercase;
                font-weight: 700;
                letter-spacing: 1px;
            ">ZatwierdÅº</button>
            <button onclick="closePinModal()" style="
                background: none;
                border: 1px solid var(--border);
                color: var(--text-secondary);
                padding: 0.5rem 1.2rem;
                cursor: pointer;
                font-size: 11px;
                text-transform: uppercase;
            ">Anuluj</button>
        </div>
    </div>
</div>

<script>
// â”€â”€ PIN Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let _pendingForm = null;  // formularz czekajÄ…cy na autoryzacjÄ™

function openPinModal(form) {
    _pendingForm = form;
    document.getElementById('pin-input').value = '';
    document.getElementById('pin-error').textContent = '';
    const modal = document.getElementById('pin-modal');
    modal.style.display = 'flex';
    setTimeout(() => document.getElementById('pin-input').focus(), 50);
}

function closePinModal() {
    document.getElementById('pin-modal').style.display = 'none';
    _pendingForm = null;
}

async function submitPin() {
    const pin = document.getElementById('pin-input').value.trim();
    if (!pin) return;

    const errorEl = document.getElementById('pin-error');
    errorEl.textContent = '';

    try {
        const res = await fetch('/auth/verify-pin', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `pin=${encodeURIComponent(pin)}`
        });
        const data = await res.json();

        if (data.ok) {
            closePinModal();
            if (_pendingForm) {
                // UsuÅ„ interceptor Å¼eby nie zapÄ™tliÄ‡
                _pendingForm._pinVerified = true;
                _pendingForm.submit();
            }
        } else {
            errorEl.textContent = data.error || 'NieprawidÅ‚owy PIN';
            document.getElementById('pin-input').value = '';
            document.getElementById('pin-input').focus();
        }
    } catch (e) {
        errorEl.textContent = 'BÅ‚Ä…d poÅ‚Ä…czenia';
    }
}

// Enter w polu PIN
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('pin-input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') submitPin();
    });

    // Przechwytuj wszystkie formularze POST â€” pokaÅ¼ modal jeÅ›li brak sesji
    document.addEventListener('submit', function(e) {
        const form = e.target;

        // PomiÅ„ GET, pomiÅ„ juÅ¼ zweryfikowane, pomiÅ„ sam formularz auth
        if (form.method.toLowerCase() === 'get') return;
        if (form._pinVerified) return;
        if (form.action && form.action.includes('/auth/')) return;

        // ZAWSZE preventDefault synchronicznie â€” potem sprawdÅº sesjÄ™ async
        e.preventDefault();

        fetch('/auth/check-session')
            .then(r => r.json())
            .then(data => {
                if (data.ok) {
                    // Sesja aktywna â€” wyÅ›lij bez modalu
                    form._pinVerified = true;
                    form.submit();
                } else {
                    // Brak sesji â€” pokaÅ¼ modal
                    openPinModal(form);
                }
            })
            .catch(() => {
                // BÅ‚Ä…d poÅ‚Ä…czenia â€” pokaÅ¼ modal
                openPinModal(form);
            });
    }, true);  // capture phase â€” przed HTMX
});

// Zamknij modal klikajÄ…c poza nim
document.getElementById('pin-modal').addEventListener('click', function(e) {
    if (e.target === this) closePinModal();
});
</script>

</body>
</html>
