{% extends "base.html" %}

{% block title %}Alerts â€” Shop Monitor{% endblock %}

{% block extra_head %}
<style>
    .filters {
        background: var(--bg-panel);
        border: 1px solid var(--border);
        padding: 1rem;
        margin-bottom: 1.5rem;
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .filter-group label {
        font-size: 10px;
        text-transform: uppercase;
        color: var(--text-secondary);
        letter-spacing: 1px;
    }

    select, input[type="text"], input[type="number"], textarea {
        background: var(--bg-dark);
        border: 1px solid var(--border);
        color: var(--text-primary);
        padding: 0.4rem 0.6rem;
        font-family: 'Fira Code', monospace;
        font-size: 12px;
    }

    .scenario-links {
        display: flex;
        gap: 0.3rem;
        flex-wrap: wrap;
        font-size: 11px;
    }

    .scenario-link {
        background: var(--bg-dark);
        border: 1px solid var(--border);
        padding: 0.2rem 0.4rem;
        color: var(--accent-green);
        text-decoration: none;
        font-family: 'Fira Code', monospace;
        font-size: 10px;
    }

    .scenario-link:hover {
        border-color: var(--accent-green);
        background: rgba(0, 255, 136, 0.1);
    }

    .repeat-badge {
        display: inline-block;
        background: var(--accent-red);
        color: var(--bg-dark);
        padding: 0.15rem 0.4rem;
        font-size: 10px;
        font-weight: 700;
        border-radius: 2px;
    }

    .resolution-hint {
        font-size: 10px;
        margin-top: 0.2rem;
        color: var(--text-secondary);
    }

    .resolution-badge {
        display: inline-block;
        padding: 0.15rem 0.4rem;
        font-size: 10px;
        font-weight: 600;
        border-radius: 2px;
        border: 1px solid;
    }

    .resolution-badge.bug           { color: #ff6b6b; border-color: #ff6b6b; }
    .resolution-badge.nab           { color: var(--text-secondary); border-color: var(--border); }
    .resolution-badge.cant_reproduce { color: #ffd93d; border-color: #ffd93d; }
    .resolution-badge.duplicate     { color: #74b9ff; border-color: #74b9ff; }
    .resolution-badge.needs_dev     { color: #fd79a8; border-color: #fd79a8; }
    .resolution-badge.config        { color: #fdcb6e; border-color: #fdcb6e; }
    .resolution-badge.script_fix    { color: #a29bfe; border-color: #a29bfe; }
    .resolution-badge.scenario_fix  { color: #55efc4; border-color: #55efc4; }

    .status.awaiting_fix          { background: #fd79a8; color: var(--bg-dark); }
    .status.awaiting_test_update  { background: #a29bfe; color: var(--bg-dark); }

    /* Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.7);
        z-index: 100;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay.active { display: flex; }

    .modal {
        background: var(--bg-panel);
        border: 1px solid var(--border);
        padding: 2rem;
        width: 420px;
        max-width: 90vw;
    }

    .modal h3 {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 1.5rem;
        color: var(--accent-green);
    }

    .form-row {
        margin-bottom: 1rem;
    }

    .form-row label {
        display: block;
        font-size: 10px;
        text-transform: uppercase;
        color: var(--text-secondary);
        margin-bottom: 0.3rem;
        letter-spacing: 1px;
    }

    .form-row select,
    .form-row input,
    .form-row textarea {
        width: 100%;
        box-sizing: border-box;
    }

    .form-row textarea { height: 80px; resize: vertical; }

    .btn-primary {
        background: var(--accent-green);
        border: none;
        color: var(--bg-dark);
        padding: 0.5rem 1.2rem;
        cursor: pointer;
        font-size: 11px;
        text-transform: uppercase;
        font-weight: 700;
        letter-spacing: 1px;
    }

    .btn-secondary {
        background: none;
        border: 1px solid var(--border);
        color: var(--text-secondary);
        padding: 0.5rem 1.2rem;
        cursor: pointer;
        font-size: 11px;
        text-transform: uppercase;
    }

    .action-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 11px;
        text-decoration: underline;
        padding: 0;
        margin-right: 0.75rem;
    }

    .backlog-section {
        margin-top: 2.5rem;
    }

    .backlog-section h3 {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 2px;
        color: var(--text-secondary);
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--border);
        padding-bottom: 0.5rem;
    }

    .id-badge {
        font-family: 'Fira Code', monospace;
        font-size: 11px;
        color: var(--text-secondary);
    }

    th { font-size: 10px; }
    td { font-size: 12px; vertical-align: middle; }
</style>
{% endblock %}

{% block content %}

{# â”€â”€ Modal: sesja analityka â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<div id="analyst-modal" class="modal-overlay">
    <div class="modal">
        <h3>Identyfikacja analityka</h3>
        <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 1.5rem;">
            Podaj imiÄ™ i nazwisko â€” zostanie zapamiÄ™tane w tej przeglÄ…darce.
        </p>
        <div class="form-row">
            <label>ImiÄ™ i nazwisko</label>
            <input type="text" id="analyst-name-input" placeholder="Jan Kowalski" style="width:100%; box-sizing:border-box;">
        </div>
        <button class="btn-primary" onclick="saveAnalystName()">Rozpocznij sesjÄ™</button>
    </div>
</div>

{# â”€â”€ Modal: resolve â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<div id="resolve-modal" class="modal-overlay">
    <div class="modal">
        <h3>Zamknij alert</h3>
        <form id="resolve-form" method="POST">
            <div class="form-row">
                <label>SposÃ³b rozwiÄ…zania *</label>
                <select name="resolution_type" id="resolve-type" onchange="toggleDuplicateField()">
                    <option value="">â€” wybierz â€”</option>
                    <optgroup label="Czeka na fix">
                        <option value="bug">ğŸ› BUG â€” bÅ‚Ä…d w aplikacji</option>
                        <option value="needs_dev">ğŸ”§ NEEDS DEV â€” wymaga rozwoju</option>
                        <option value="config">âš™ï¸ CONFIG â€” wymaga konfiguracji</option>
                    </optgroup>
                    <optgroup label="Czeka na testy">
                        <option value="script_fix">ğŸ“ SCRIPT FIX â€” bÅ‚Ä…d w skrypcie</option>
                        <option value="scenario_fix">ğŸ”„ SCENARIO FIX â€” wymaga poprawy scenariusza</option>
                    </optgroup>
                    <optgroup label="ZamkniÄ™te">
                        <option value="nab">âš ï¸ NAB â€” not a bug</option>
                        <option value="duplicate">ğŸ”— DUPLICATE â€” duplikat</option>
                        <option value="cant_reproduce">â“ CANT REPRODUCE â€” nie moÅ¼na odtworzyÄ‡</option>
                    </optgroup>
                </select>
            </div>

            <div class="form-row" id="duplicate-field" style="display:none;">
                <label>ID alertu nadrzÄ™dnego *</label>
                <input type="number" name="duplicate_of_id" placeholder="np. 42" min="1">
                <div style="font-size: 10px; color: var(--text-secondary); margin-top: 0.3rem;">
                    Wpisz ID (#) alertu ktÃ³ry jest oryginaÅ‚em
                </div>
            </div>

            <div class="form-row">
                <label>Nietatka</label>
                <textarea name="resolution_note" placeholder="Opcjonalny komentarz, numer ticketu..."></textarea>
            </div>

            <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                <button type="submit" class="btn-primary">Zamknij alert</button>
                <button type="button" class="btn-secondary" onclick="closeModal('resolve-modal')">Anuluj</button>
            </div>
        </form>
    </div>
</div>

{# â”€â”€ NagÅ‚Ã³wek â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<h2 style="font-size: 14px; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 1.5rem;">
    Alerts
    <span id="analyst-label" style="font-size: 11px; color: var(--text-secondary); font-weight: normal; margin-left: 1rem;"></span>
</h2>

{# â”€â”€ Statystyki â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; font-size: 12px;">
    <div style="background: var(--bg-panel); border: 1px solid var(--border); padding: 1rem; flex: 1;">
        <div style="color: var(--text-secondary); text-transform: uppercase; font-size: 10px; margin-bottom: 0.5rem;">Active</div>
        <div style="font-size: 24px; color: var(--accent-red);">{{ total_open }}</div>
    </div>
    <div style="background: var(--bg-panel); border: 1px solid var(--border); padding: 1rem; flex: 1;">
        <div style="color: var(--text-secondary); text-transform: uppercase; font-size: 10px; margin-bottom: 0.5rem;">Awaiting Fix</div>
        <div style="font-size: 24px; color: #fd79a8;">{{ total_awaiting }}</div>
    </div>
    <div style="background: var(--bg-panel); border: 1px solid var(--border); padding: 1rem; flex: 1;">
        <div style="color: var(--text-secondary); text-transform: uppercase; font-size: 10px; margin-bottom: 0.5rem;">Closed</div>
        <div style="font-size: 24px; color: var(--accent-green);">{{ total_closed }}</div>
    </div>
</div>

{# â”€â”€ Filtry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<form method="GET" class="filters">
    <div class="filter-group">
        <label>Status:</label>
        <select name="status" onchange="this.form.submit()">
            <option value="active"   {% if current_status == 'active'   %}selected{% endif %}>Active</option>
            <option value="awaiting" {% if current_status == 'awaiting' %}selected{% endif %}>Awaiting</option>
            <option value="closed"   {% if current_status == 'closed'   %}selected{% endif %}>Closed</option>
            <option value="all"      {% if current_status == 'all'      %}selected{% endif %}>All</option>
        </select>
    </div>

    <div class="filter-group">
        <label>Environment:</label>
        <select name="environment_id" onchange="this.form.submit()">
            <option value="all" {% if current_environment == 'all' %}selected{% endif %}>All</option>
            {% for env in environments %}
            <option value="{{ env.id }}" {% if current_environment == env.id|string %}selected{% endif %}>
                {{ env.name }}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="filter-group">
        <label>Search:</label>
        <input type="text" name="search" value="{{ search_query }}" placeholder="Title or rule...">
    </div>

    <button type="submit" class="btn-primary">Filter</button>
</form>

{# â”€â”€ Tabela alertÃ³w â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<table>
    <thead>
        <tr>
            <th>ID</th>
            <th>Suite</th>
            <th>Env</th>
            <th>Status</th>
            <th>Resolution</th>
            <th>Typ</th>
            <th>TytuÅ‚</th>
            <th>Scenariusze</th>
            <th>Last Seen</th>
            <th>Repeats</th>
            <th>Assigned</th>
            <th>Akcje</th>
        </tr>
    </thead>
    <tbody>
        {% for alert in alert_groups %}
        <tr>
            {# ID #}
            <td>
                <a href="/alerts/{{ alert.id }}" class="link id-badge">#{{ alert.id }}</a>
            </td>

            {# Suite #}
            <td class="mono" style="font-size: 11px;">
                <a href="/suite-runs/{{ alert.last_suite_run_id }}" class="link">
                    {{ alert.last_suite_run.suite.name }}
                </a>
            </td>

            {# Env #}
            <td class="mono" style="font-size: 11px;">
                {{ alert.last_suite_run.environment.name }}
            </td>

            {# Status #}
            <td>
                <span class="status {{ alert.status.value }}">{{ alert.status.value.replace('_', ' ') }}</span>
            </td>

            {# Resolution â€” oznaczenia kontekstowe #}
            <td>
                {% if alert.resolution_type %}
                    <span class="resolution-badge {{ alert.resolution_type }}">
                        {{ alert.resolution_type.replace('_', ' ').upper() }}
                    </span>
                    {% if alert.status.value == 'open' and alert.resolution_type in ['nab', 'cant_reproduce'] %}
                        <div class="resolution-hint">powrÃ³t po zamkniÄ™ciu</div>
                    {% endif %}
                    {% if alert.resolution_type == 'duplicate' and alert.duplicate_of_id %}
                        <div class="resolution-hint">â†’ #{{ alert.duplicate_of_id }}</div>
                    {% endif %}
                {% endif %}
            </td>

            {# Alert Type #}
            <td>
                <span class="status {{ 'failed' if alert.alert_type == 'bug' else 'running' }}">
                    {{ alert.alert_type }}
                </span>
            </td>

            {# Title â€” link do szczegÃ³Å‚Ã³w #}
            <td style="font-weight: 500; max-width: 280px;">
                <a href="/alerts/{{ alert.id }}" class="link">{{ alert.title }}</a>
                {% if alert.resolution_note and alert.status.value in ['awaiting_fix', 'awaiting_test_update', 'in_progress'] %}
                <div style="font-size: 10px; color: var(--text-secondary); margin-top: 0.2rem;">
                    {{ alert.resolution_note[:60] }}{% if alert.resolution_note|length > 60 %}â€¦{% endif %}
                </div>
                {% endif %}
            </td>

            {# Scenarios #}
            <td>
                <div class="scenario-links">
                    {% set scenario_ids = alert.scenario_ids | parse_json %}
                    {% for sid in scenario_ids %}
                    <a href="/scenarios/{{ sid }}" class="scenario-link">#{{ sid }}</a>
                    {% endfor %}
                </div>
            </td>

            {# Last Seen #}
            <td class="mono" style="font-size: 11px;">
                {{ alert.last_seen_at | local_time }}
            </td>

            {# Repeats #}
            <td class="mono" style="text-align: center;">
                {% if alert.repeat_count > 1 %}
                <span class="repeat-badge">Ã—{{ alert.repeat_count }}</span>
                {% else %}
                <span style="color: var(--text-secondary);">Ã—1</span>
                {% endif %}
                {% if alert.clean_runs_count > 0 %}
                <div style="font-size: 10px; color: var(--accent-green); margin-top: 0.2rem;">
                    {{ alert.clean_runs_count }} clean
                </div>
                {% endif %}
            </td>

            {# Assigned #}
            <td style="font-size: 11px; color: var(--text-secondary);">
                {% if alert.assigned_to %}
                    ğŸ‘¤ {{ alert.assigned_to }}
                {% endif %}
            </td>

            {# Actions #}
            <td style="white-space: nowrap;">
                {% if alert.status.value == 'open' %}
                    <form method="POST" action="/alerts/{{ alert.id }}/assign" style="display:inline;" onsubmit="injectAnalystName(this)">
                        <input type="hidden" name="analyst_name" value="">
                        <button type="submit" class="action-btn" style="color: var(--accent-yellow);">Start</button>
                    </form>

                {% elif alert.status.value == 'in_progress' %}
                    <button class="action-btn" style="color: var(--accent-green);"
                            onclick="openResolveModal({{ alert.id }})">Resolve</button>

                {% elif alert.status.value in ['awaiting_fix', 'awaiting_test_update'] %}
                    <button class="action-btn" style="color: var(--accent-green);"
                            onclick="openResolveModal({{ alert.id }})">Update</button>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% if not alert_groups %}
<div style="padding: 3rem; text-align: center; color: var(--text-secondary);">
    Nie alerts found
</div>
{% endif %}

{# â”€â”€ Sekcja Backlog â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
{% if backlog and current_status in ['active', 'all'] %}
<div class="backlog-section">
    <h3>â³ Backlog â€” czeka na poprawÄ™ ({{ backlog|length }})</h3>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Resolution</th>
                <th>TytuÅ‚</th>
                <th>Env</th>
                <th>Repeats</th>
                <th>Assigned</th>
                <th>Nietatka</th>
                <th>Akcje</th>
            </tr>
        </thead>
        <tbody>
            {% for alert in backlog %}
            <tr>
                <td><a href="/alerts/{{ alert.id }}" class="link id-badge">#{{ alert.id }}</a></td>
                <td>
                    <span class="resolution-badge {{ alert.resolution_type }}">
                        {{ alert.resolution_type.replace('_', ' ').upper() if alert.resolution_type else 'â€”' }}
                    </span>
                    <div style="font-size: 10px; color: var(--text-secondary); margin-top: 0.2rem;">
                        {{ alert.status.value.replace('_', ' ') }}
                    </div>
                </td>
                <td style="font-weight: 500;">
                    <a href="/alerts/{{ alert.id }}" class="link">{{ alert.title }}</a>
                </td>
                <td class="mono" style="font-size: 11px;">
                    {{ alert.last_suite_run.environment.name }}
                </td>
                <td class="mono" style="text-align: center;">
                    <span class="repeat-badge">Ã—{{ alert.repeat_count }}</span>
                </td>
                <td style="font-size: 11px; color: var(--text-secondary);">
                    {% if alert.assigned_to %}ğŸ‘¤ {{ alert.assigned_to }}{% endif %}
                </td>
                <td style="font-size: 11px; color: var(--text-secondary); max-width: 200px;">
                    {{ alert.resolution_note[:80] if alert.resolution_note else 'â€”' }}
                    {% if alert.resolution_note and alert.resolution_note|length > 80 %}â€¦{% endif %}
                </td>
                <td style="white-space: nowrap;">
                    <form method="POST" action="/alerts/{{ alert.id }}/close" style="display:inline;">
                        <button type="submit" class="action-btn" style="color: var(--accent-green);">
                            Close
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{# â”€â”€ JavaScript â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<script>
// â”€â”€ Sesja analityka â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', function() {
    const name = localStorage.getItem('analyst_name');
    if (!name) {
        document.getElementById('analyst-modal').classList.add('active');
    } else {
        document.getElementById('analyst-label').textContent = 'ğŸ‘¤ ' + name;
    }
});

function saveAnalystName() {
    const input = document.getElementById('analyst-name-input');
    const name = input.value.trim();
    if (!name) return;
    localStorage.setItem('analyst_name', name);
    document.getElementById('analyst-modal').classList.remove('active');
    document.getElementById('analyst-label').textContent = 'ğŸ‘¤ ' + name;
}

function injectAnalystName(form) {
    const name = localStorage.getItem('analyst_name') || '';
    form.querySelector('input[name="analyst_name"]').value = name;
}

// â”€â”€ Resolve modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openResolveModal(alertId) {
    const form = document.getElementById('resolve-form');
    form.action = '/alerts/' + alertId + '/resolve';
    // Reset
    form.querySelector('select[name="resolution_type"]').value = '';
    form.querySelector('textarea[name="resolution_note"]').value = '';
    const dupInput = form.querySelector('input[name="duplicate_of_id"]');
    if (dupInput) dupInput.value = '';
    toggleDuplicateField();
    document.getElementById('resolve-modal').classList.add('active');
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

function toggleDuplicateField() {
    const type = document.getElementById('resolve-type').value;
    const field = document.getElementById('duplicate-field');
    field.style.display = (type === 'duplicate') ? 'block' : 'none';
}

// Zamknij modal klikajÄ…c poza nim
document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', function(e) {
        if (e.target === this) this.classList.remove('active');
    });
});
</script>

{% endblock %}
