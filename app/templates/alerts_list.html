{% extends "base.html" %}

{% block title %}Alerts â€” Shop Monitor{% endblock %}

{% block extra_head %}
<style>
    .filters {
        background: var(--bg-panel);
        border: 1px solid var(--border);
        padding: 1rem;
        margin-bottom: 1.5rem;
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .filter-group {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    
    .filter-group label {
        font-size: 10px;
        text-transform: uppercase;
        color: var(--text-secondary);
        letter-spacing: 1px;
    }
    
    select, input[type="text"] {
        background: var(--bg-dark);
        border: 1px solid var(--border);
        color: var(--text-primary);
        padding: 0.5rem;
        font-family: 'IBM Plex Mono', monospace;
        font-size: 12px;
    }
    
    .scenario-links {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        font-size: 11px;
    }
    
    .scenario-link {
        background: var(--bg-dark);
        border: 1px solid var(--border);
        padding: 0.25rem 0.5rem;
        color: var(--accent-green);
        text-decoration: none;
        font-family: 'IBM Plex Mono', monospace;
    }
    
    .scenario-link:hover {
        border-color: var(--accent-green);
        background: rgba(0, 255, 136, 0.1);
    }
    
    .repeat-badge {
        display: inline-block;
        background: var(--accent-red);
        color: var(--bg-dark);
        padding: 0.25rem 0.5rem;
        font-size: 10px;
        font-weight: 700;
        border-radius: 2px;
        margin-left: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<h2 style="font-size: 14px; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 1.5rem;">
    Alerts
</h2>

<!-- Stats -->
<div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; font-size: 12px;">
    <div style="background: var(--bg-panel); border: 1px solid var(--border); padding: 1rem; flex: 1;">
        <div style="color: var(--text-secondary); text-transform: uppercase; font-size: 10px; margin-bottom: 0.5rem;">Open</div>
        <div style="font-size: 24px; color: var(--accent-red);">{{ total_open }}</div>
    </div>
    <div style="background: var(--bg-panel); border: 1px solid var(--border); padding: 1rem; flex: 1;">
        <div style="color: var(--text-secondary); text-transform: uppercase; font-size: 10px; margin-bottom: 0.5rem;">In Progress</div>
        <div style="font-size: 24px; color: var(--accent-yellow);">{{ total_in_progress }}</div>
    </div>
    <div style="background: var(--bg-panel); border: 1px solid var(--border); padding: 1rem; flex: 1;">
        <div style="color: var(--text-secondary); text-transform: uppercase; font-size: 10px; margin-bottom: 0.5rem;">Closed</div>
        <div style="font-size: 24px; color: var(--accent-green);">{{ total_closed }}</div>
    </div>
</div>

<!-- Filters -->
<form method="GET" class="filters">
    <div class="filter-group">
        <label>Status:</label>
        <select name="status" onchange="this.form.submit()">
            <option value="active" {% if current_status == 'active' %}selected{% endif %}>Active</option>
            <option value="closed" {% if current_status == 'closed' %}selected{% endif %}>Closed</option>
            <option value="all" {% if current_status == 'all' %}selected{% endif %}>All</option>
        </select>
    </div>
    
    <div class="filter-group">
        <label>Environment:</label>
        <select name="environment_id" onchange="this.form.submit()">
            <option value="all" {% if current_environment == 'all' %}selected{% endif %}>All</option>
            {% for env in environments %}
            <option value="{{ env.id }}" {% if current_environment == env.id|string %}selected{% endif %}>
                {{ env.name }}
            </option>
            {% endfor %}
        </select>
    </div>
    
    <div class="filter-group">
        <label>Search:</label>
        <input type="text" name="search" value="{{ search_query }}" placeholder="Title or rule...">
    </div>
    
    <button type="submit" style="padding: 0.5rem 1rem; background: var(--accent-green); border: none; color: var(--bg-dark); cursor: pointer; font-size: 11px; text-transform: uppercase;">
        Filter
    </button>
</form>

<!-- Alerts Table -->
<table>
    <thead>
        <tr>
            <th>Last Seen</th>
            <th>Type</th>
            <th>Title</th>
            <th>Suite</th>
            <th>Environment</th>
            <th>Scenarios</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for alert in alert_groups %}
        <tr>
            <td class="mono" style="font-size: 11px;">
                {{ alert.last_seen_at | local_time }}
                {% if alert.repeat_count > 1 %}
                <span class="repeat-badge">{{ alert.repeat_count }}x</span>
                {% endif %}
            </td>
            <td>
                <span class="status {{ 'failed' if alert.alert_type == 'bug' else 'running' }}">
                    {{ alert.alert_type }}
                </span>
            </td>
            <td style="font-weight: 500;">
                {{ alert.title }}
                {% if alert.repeat_count > 1 %}
                <div style="font-size: 10px; color: var(--text-secondary); margin-top: 0.25rem;">
                    Repeated {{ alert.repeat_count }} times
                </div>
                {% endif %}
            </td>
            <td class="mono" style="font-size: 11px;">
                <a href="/suite-runs/{{ alert.last_suite_run_id }}" class="link">
                    {{ alert.last_suite_run.suite.name }}
                </a>
            </td>
            <td class="mono" style="font-size: 11px;">
                {{ alert.last_suite_run.environment.name }}
            </td>
            <td>
                <div class="scenario-links">
                    {% set scenario_ids = alert.scenario_ids | parse_json %}
                    {% for sid in scenario_ids %}
                    <a href="/scenarios/{{ sid }}" class="scenario-link">#{{ sid }}</a>
                    {% endfor %}
                    {% if alert.occurrence_count > scenario_ids|length %}
                    <span style="color: var(--text-secondary); font-size: 10px; margin-left: 0.25rem;">
                        ({{ alert.occurrence_count }}x)
                    </span>
                    {% endif %}
                </div>
            </td>
            <td>
                <span class="status {{ alert.status.value }}">{{ alert.status.value }}</span>
            </td>
            <td>
                <form method="POST" action="/alerts/{{ alert.id }}/status" style="display: inline;">
                    {% if alert.status.value == 'open' %}
                    <input type="hidden" name="new_status" value="in_progress">
                    <button type="submit" style="background: none; border: none; color: var(--accent-yellow); cursor: pointer; font-size: 11px; text-decoration: underline;">
                        Start
                    </button>
                    {% elif alert.status.value == 'in_progress' %}
                    <input type="hidden" name="new_status" value="closed">
                    <button type="submit" style="background: none; border: none; color: var(--accent-green); cursor: pointer; font-size: 11px; text-decoration: underline;">
                        Close
                    </button>
                    {% endif %}
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% if not alert_groups %}
<div style="padding: 3rem; text-align: center; color: var(--text-secondary);">
    No alerts found
</div>
{% endif %}
{% endblock %}
